<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Faturas Avan√ßado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f5f7fa;
            --container-bg: #ffffff;
            --text-color: #2c3e50;
            --border-color: #e1e8ed;
            --hover-bg: #f8f9fb;
            --header-bg: #f1f3f5;
            --header-hover: #e9ecef;
            --shadow: rgba(0,0,0,0.08);
            --primary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --transition-speed: 0.3s;
        }
        [data-theme="dark"] {
            --bg-color: #1a1d23;
            --container-bg: #242830;
            --text-color: #e4e6eb;
            --border-color: #3a3f4a;
            --hover-bg: #2c313a;
            --header-bg: #2c313a;
            --header-hover: #363b45;
            --shadow: rgba(0,0,0,0.4);
            --primary-color: #5dade2;
            --success-color: #58d68d;
            --danger-color: #ec7063;
            --warning-color: #f8c471;
        }
        * {
            box-sizing: border-box;
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            transition: all var(--transition-speed) ease;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow);
        }
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .theme-toggle, .filter-toggle, .view-toggle {
            background: var(--header-bg);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .theme-toggle:hover, .filter-toggle:hover, .view-toggle:hover {
            background-color: var(--header-hover);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px var(--shadow);
        }
        h1 {
            text-align: center;
            color: var(--text-color);
            margin: 0;
            flex: 1;
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--primary-color), #3F51B5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
            border-radius: 8px 8px 0 0;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            color: var(--text-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab.active {
            border-bottom-color: var(--primary-color);
            background-color: var(--header-bg);
            border-radius: 8px 8px 0 0;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .dashboard-card {
            background: var(--header-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 8px var(--shadow);
            transition: transform 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .card-title {
            font-size: 1rem;
            margin: 0 0 15px 0;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
        }
        .card-detail {
            font-size: 0.9rem;
            margin: 5px 0 0 0;
            color: var(--text-color);
            opacity: 0.8;
        }
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .quick-action-btn {
            padding: 10px 15px;
            background: var(--header-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .quick-action-btn:hover {
            background: var(--header-hover);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px var(--shadow);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: var(--container-bg);
            box-shadow: 0 2px 8px var(--shadow);
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        th {
            background-color: var(--header-bg);
            font-weight: bold;
            cursor: pointer;
            position: relative;
            font-weight: 600;
        }
        th:hover {
            background-color: var(--header-hover);
        }
        tr {
            transition: background-color 0.2s ease;
        }
        tr:hover {
            background-color: var(--hover-bg);
        }
        .amount {
            font-weight: bold;
        }
        .paid {
            color: var(--success-color);
        }
        .unpaid {
            color: var(--danger-color);
        }
        .btn {
            padding: 8px 12px;
            margin: 2px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px var(--shadow);
        }
        .btn-add { background-color: var(--success-color); color: white; }
        .btn-edit { background-color: var(--primary-color); color: white; }
        .btn-delete { background-color: var(--danger-color); color: white; }
        .btn-paid { background-color: var(--success-color); color: white; }
        .btn-export { background-color: var(--warning-color); color: white; }
        .btn-import { background-color: #9c27b0; color: white; }
        .btn-pdf { background-color: var(--danger-color); color: white; }
        .form-group {
            margin: 10px 0;
        }
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }
        input[type="text"], input[type="number"], input[type="date"], select, input[type="file"] {
            padding: 12px;
            margin: 5px 0 10px 0;
            display: inline-block;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--container-bg);
            color: var(--text-color);
            font-size: 16px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.2);
        }
        input:invalid {
            border-color: var(--danger-color);
        }
        .summary {
            background: linear-gradient(135deg, var(--success-color), #66BB6A);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: bold;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        [data-theme="dark"] .summary {
            background: linear-gradient(135deg, #1e3a28, #2d5a3d);
        }
        .filter-container {
            margin: 20px 0;
            padding: 20px;
            background-color: var(--header-bg);
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow);
        }
        .filter-container.hidden {
            display: none;
        }
        .filter-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .notification {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: none;
            animation: slideIn 0.5s ease;
            position: relative;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .notification.success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        .notification.error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }
        .notification.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .notification.info {
            background-color: #e7f3fe;
            color: #0c5460;
            border: 1px solid #b3d7ff;
        }
        [data-theme="dark"] .notification.success {
            background-color: #1e3a28;
            color: #7dd87d;
            border-color: #2d5a3d;
        }
        [data-theme="dark"] .notification.error {
            background-color: #3a1e1e;
            color: #ff7d7d;
            border-color: #5a2d2d;
        }
        [data-theme="dark"] .notification.warning {
            background-color: #3a2e1e;
            color: #ffd27d;
            border-color: #5a452d;
        }
        [data-theme="dark"] .notification.info {
            background-color: #1e2a3a;
            color: #7db8ff;
            border-color: #2d455a;
        }
        .warning { color: var(--warning-color); font-weight: bold; }
        .expired { color: var(--danger-color); font-weight: bold; }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .chart-container {
            margin: 20px 0;
            height: 400px;
            background: var(--container-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background-color: var(--header-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow);
            transition: transform 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }
        .export-controls {
            margin: 20px 0;
            padding: 20px;
            background-color: var(--header-bg);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        .export-controls button {
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .categoria-tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 5px;
            font-weight: 500;
        }
        [data-theme="dark"] .categoria-tag {
            color: #ffffff !important;
            opacity: 0.9;
        }
        .recorrente-badge {
            color: var(--warning-color);
            font-weight: bold;
        }
        .hidden {
            display: none;
        }
        .close-btn {
            float: right;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: inherit;
        }
        /* Mobile menu */
        .mobile-tabs-menu {
            display: none;
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 16px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        .pagination button {
            padding: 8px 12px;
            background-color: var(--header-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s ease;
        }
        .pagination button:hover {
            background-color: var(--header-hover);
        }
        .pagination button.active {
            background-color: var(--primary-color);
            color: white;
        }
        .search-advanced {
            margin-top: 10px;
            padding: 15px;
            background-color: var(--header-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        .sort-indicator {
            margin-left: 5px;
        }
        /* Modal de confirma√ß√£o */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            animation: scaleIn 0.3s ease;
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        /* Calendar View */
        .calendar-view {
            display: none;
            margin-top: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        .calendar-day {
            background: var(--header-bg);
            border-radius: 8px;
            padding: 10px;
            min-height: 100px;
            position: relative;
        }
        .calendar-day-header {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .calendar-event {
            background: var(--primary-color);
            color: white;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
            cursor: pointer;
        }
        .calendar-event.paid {
            background: var(--success-color);
        }
        .calendar-event.expired {
            background: var(--danger-color);
        }
        /* Smart Search */
        .search-suggestions {
            position: absolute;
            background: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 15px var(--shadow);
            display: none;
        }
        .search-suggestion {
            padding: 10px;
            cursor: pointer;
        }
        .search-suggestion:hover {
            background: var(--hover-bg);
        }
        /* Category colors */
        .category-color-1 { background-color: #FF5252; color: white; }
        .category-color-2 { background-color: #FF4081; color: white; }
        .category-color-3 { background-color: #E040FB; color: white; }
        .category-color-4 { background-color: #7C4DFF; color: white; }
        .category-color-5 { background-color: #536DFE; color: white; }
        .category-color-6 { background-color: #448AFF; color: white; }
        .category-color-7 { background-color: #40C4FF; color: white; }
        .category-color-8  { background-color: #18FFFF; color: #333; }
        .category-color-9  { background-color: #64FFDA; color: #333; }
        .category-color-10 { background-color: #69F0AE; color: white; }
        .category-color-11 { background-color: #B2FF59; color: #333; }
        .category-color-12 { background-color: #EEFF41; color: #333; }
        .category-color-13 { background-color: #FFFF00; color: #333; }
        .category-color-14 { background-color: #FFD740; color: #333; }
        .category-color-15 { background-color: #FFAB40; color: white; }
        .category-color-16 { background-color: #FF6E40; color: white; }
        [data-theme="dark"] .category-color-8,
        [data-theme="dark"] .category-color-9,
        [data-theme="dark"] .category-color-11,
        [data-theme="dark"] .category-color-12,
        [data-theme="dark"] .category-color-13,
        [data-theme="dark"] .category-color-14 {
            color: white;
        }
        /* Alert settings */
        .alert-settings {
            margin-top: 20px;
            padding: 20px;
            background: var(--header-bg);
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        /* Responsividade */
        @media (max-width: 1024px) {
            .dashboard-cards {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                text-align: center;
            }
            .form-row {
                flex-direction: column;
            }
            .filter-group {
                display: block;
                margin-right: 0;
                margin-bottom: 15px;
            }
            th, td {
                padding: 10px;
                font-size: 14px;
            }
            .btn {
                padding: 6px 10px;
                font-size: 12px;
                margin: 2px;
            }
            .tabs {
                display: none;
            }
            .mobile-tabs-menu {
                display: block;
            }
            .export-controls button {
                width: 100%;
                margin-right: 0;
            }
            .container {
                padding: 15px;
            }
            .calendar-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            .card-value {
                font-size: 1.5rem;
            }
            .quick-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-controls">
            <button class="theme-toggle" onclick="alternarTema()" aria-label="Alternar entre tema claro e escuro">
                <i class="fas fa-moon"></i> Tema
            </button>
            <button class="filter-toggle" onclick="alternarFiltros()" aria-label="Mostrar/Ocultar filtros">
                <i class="fas fa-filter"></i> Filtros
            </button>
            <h1><i class="fas fa-file-invoice-dollar"></i> Gerenciador de Faturas Avan√ßado</h1>
            <button class="view-toggle" onclick="alternarVisualizacao()" aria-label="Alternar entre visualiza√ß√£o de tabela e calend√°rio">
                <i class="fas fa-calendar-alt"></i> Ver Calend√°rio
            </button>
        </div>
        <div id="notification" class="notification" role="status" aria-live="polite"></div>
        <!-- Nova notifica√ß√£o para vencimentos pr√≥ximos -->
        <div id="notificacaoVencimento" class="notification warning" style="display: none;">
            <button class="close-btn" onclick="fecharNotificacaoVencimento()" aria-label="Fechar notifica√ß√£o">‚úñ</button>
            <strong><i class="fas fa-exclamation-triangle"></i> Aviso de Vencimento</strong>
            <div id="listaVencimentoProximo"></div>
        </div>
        <select class="mobile-tabs-menu" onchange="mostrarAbaMobile(this.value)" aria-label="Selecionar aba no modo mobile">
            <option value="faturas"><i class="fas fa-file-invoice"></i> Faturas</option>
            <option value="analytics"><i class="fas fa-chart-line"></i> An√°lises</option>
            <option value="backup"><i class="fas fa-database"></i> Backup</option>
        </select>
        <div class="tabs">
            <div class="tab active" data-aba="faturas" onclick="mostrarAba(event, 'faturas')">
                <i class="fas fa-file-invoice"></i> Faturas
            </div>
            <div class="tab" data-aba="analytics" onclick="mostrarAba(event, 'analytics')">
                <i class="fas fa-chart-line"></i> An√°lises
            </div>
            <div class="tab" data-aba="backup" onclick="mostrarAba(event, 'backup')">
                <i class="fas fa-database"></i> Backup
            </div>
        </div>
        <!-- ABA FATURAS -->
        <div id="faturas" class="tab-content active">
            <!-- Dashboard de Resumo -->
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Total Pendente</h3>
                    <p class="card-value" id="dashboard-total-pendente">R$ 0,00</p>
                    <p class="card-detail">Valor total das faturas em aberto</p>
                </div>
                <div class="dashboard-card">
                    <h3 class="card-title"><i class="fas fa-check-circle"></i> Total Pago</h3>
                    <p class="card-value" id="dashboard-total-pago">R$ 0,00</p>
                    <p class="card-detail">Valor total das faturas pagas</p>
                </div>
                <div class="dashboard-card">
                    <h3 class="card-title"><i class="fas fa-calendar-day"></i> Pr√≥ximos Vencimentos</h3>
                    <p class="card-value" id="dashboard-proximos-vencimentos">0</p>
                    <p class="card-detail">Faturas a vencer em 7 dias</p>
                </div>
                <div class="dashboard-card">
                    <h3 class="card-title"><i class="fas fa-exclamation-triangle"></i> Atrasadas</h3>
                    <p class="card-value" id="dashboard-atrasadas">0</p>
                    <p class="card-detail">Faturas em atraso</p>
                </div>
            </div>
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="scrollToForm()">
                    <i class="fas fa-plus"></i> Nova Fatura
                </button>
                <button class="quick-action-btn" onclick="adicionarFaturaRapida()">
                    <i class="fas fa-save"></i> Adicionar Fatura
                </button>
                <button class="quick-action-btn" onclick="filtrarPorStatus('pendente')">
                    <i class="fas fa-clock"></i> Ver Pendentes
                </button>
                <button class="quick-action-btn" onclick="filtrarPorStatus('pago')">
                    <i class="fas fa-check"></i> Ver Pagas
                </button>
                <button class="quick-action-btn" onclick="filtrarPorVencimentoProximo()">
                    <i class="fas fa-calendar-day"></i> Pr√≥ximos Vencimentos
                </button>
            </div>
            <form id="formFatura" onsubmit="adicionarFatura(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="tipo">Tipo:</label>
                        <select id="tipo" required>
                            <option value="">Selecione um tipo</option>
                            <option value="cartao">üí≥ Cart√£o de Cr√©dito</option>
                            <option value="celular">üì± Celular</option>
                            <option value="internet">üõú Internet</option>
                            <option value="boleto">üìÉ Boleto</option>
                            <option value="streaming">üì∫ Streaming</option>
                            <option value="seguro">üõ°Ô∏è Seguro</option>
                            <option value="financiamento">üè† Financiamento</option>
                            <option value="outros">üì¶ Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nome">Nome:</label>
                        <input type="text" id="nome" placeholder="Nome do cart√£o ou servi√ßo" required>
                        <div id="suggestions-container" class="search-suggestions"></div>
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoria:</label>
                        <input type="text" id="categoria" list="categoriasSugeridas" placeholder="Ex: Casa, Pessoal, Trabalho">
                        <datalist id="categoriasSugeridas"></datalist>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="fechamento">Data de Fechamento:</label>
                        <input type="date" id="fechamento" required>
                    </div>
                    <div class="form-group">
                        <label for="vencimento">Data de Vencimento:</label>
                        <input type="date" id="vencimento" required>
                    </div>
                    <div class="form-group">
                        <label for="valor">Valor:</label>
                        <input type="number" id="valor" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="recorrente"> üîÑ Conta recorrente (gerar automaticamente no pr√≥ximo m√™s)
                    </label>
                </div>
                <button type="button" class="btn" id="btnCancel" onclick="cancelarEdicao()" style="display: none; background-color: #9e9e9e;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </form>
            <div class="filter-container" id="filterContainer">
                <div class="filter-group">
                    <label for="filtroTipo">Filtrar por tipo:</label>
                    <select id="filtroTipo" onchange="filtrarFaturas()">
                        <option value="">Todos</option>
                        <option value="cartao">Cart√£o de Cr√©dito</option>
                        <option value="celular">Celular</option>
                        <option value="internet">Internet</option>
                        <option value="boleto">Boleto</option>
                        <option value="streaming">Streaming</option>
                        <option value="seguro">Seguro</option>
                        <option value="financiamento">Financiamento</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filtroStatus">Filtrar por status:</label>
                    <select id="filtroStatus" onchange="filtrarFaturas()">
                        <option value="">Todos</option>
                        <option value="pago">Pagos</option>
                        <option value="pendente">Pendentes</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filtroCategoria">Filtrar por categoria:</label>
                    <select id="filtroCategoria" onchange="filtrarFaturas()">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="buscaNome">Buscar por nome:</label>
                    <input type="text" id="buscaNome" placeholder="Buscar..." oninput="mostrarSugestoes(this.value)">
                    <div id="suggestions-container-table" class="search-suggestions"></div>
                </div>
                <div class="filter-group">
                    <button class="btn" onclick="toggleAdvancedSearch()">
                        <i class="fas fa-search-plus"></i> Busca Avan√ßada
                    </button>
                </div>
            </div>
            <div id="advancedSearch" class="search-advanced" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="buscaValorMin">Valor M√≠nimo:</label>
                        <input type="number" id="buscaValorMin" placeholder="0.00" step="0.01" min="0" onchange="filtrarFaturas()">
                    </div>
                    <div class="form-group">
                        <label for="buscaValorMax">Valor M√°ximo:</label>
                        <input type="number" id="buscaValorMax" placeholder="0.00" step="0.01" min="0" onchange="filtrarFaturas()">
                    </div>
                    <div class="form-group">
                        <label for="buscaDataInicio">De:</label>
                        <input type="date" id="buscaDataInicio" onchange="filtrarFaturas()">
                    </div>
                    <div class="form-group">
                        <label for="buscaDataFim">At√©:</label>
                        <input type="date" id="buscaDataFim" onchange="filtrarFaturas()">
                    </div>
                </div>
            </div>
            <!-- Visualiza√ß√£o em Tabela -->
            <div id="tableView" style="overflow-x: auto;">
                <table id="tabelaFaturas">
                    <thead>
                        <tr>
                            <th onclick="ordenarTabela('tipo')">Tipo <span class="sort-indicator" id="sort-tipo">‚Üï</span></th>
                            <th onclick="ordenarTabela('nome')">Nome <span class="sort-indicator" id="sort-nome">‚Üï</span></th>
                            <th onclick="ordenarTabela('categoria')">Categoria <span class="sort-indicator" id="sort-categoria">‚Üï</span></th>
                            <th onclick="ordenarTabela('fechamento')">Fechamento <span class="sort-indicator" id="sort-fechamento">‚Üï</span></th>
                            <th onclick="ordenarTabela('vencimento')">Vencimento <span class="sort-indicator" id="sort-vencimento">‚Üï</span></th>
                            <th onclick="ordenarTabela('valor')">Valor <span class="sort-indicator" id="sort-valor">‚Üï</span></th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <!-- Visualiza√ß√£o em Calend√°rio -->
            <div id="calendarView" class="calendar-view">
                <div class="calendar-header">
                    <button class="btn" onclick="mudarMesCalendar(-1)">
                        <i class="fas fa-chevron-left"></i> M√™s Anterior
                    </button>
                    <h3 id="calendarMonth">Setembro 2023</h3>
                    <button class="btn" onclick="mudarMesCalendar(1)">
                        Pr√≥ximo M√™s <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Os dias ser√£o preenchidos via JavaScript -->
                </div>
            </div>
            <div class="pagination" id="paginacao"></div>
            <div class="summary" id="resumoTotal">
                ‚è≥Ô∏è Total de faturas pendentes: R$ 0,00<br>
                üí∞ Total de faturas pagas: R$ 0,00
            </div>
            <!-- Configura√ß√µes de Alerta -->
            <div class="alert-settings">
                <h3><i class="fas fa-bell"></i> Configura√ß√µes de Alerta</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="alertaDias">Alertar sobre vencimentos em (dias):</label>
                        <input type="number" id="alertaDias" min="1" max="30" value="7" onchange="salvarConfiguracoesAlerta()">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="alertaEmail" onchange="salvarConfiguracoesAlerta()">
                            Receber alertas por e-mail
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="alertaNotificacao" checked onchange="salvarConfiguracoesAlerta()">
                            Mostrar notifica√ß√µes no sistema
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <!-- ABA AN√ÅLISES -->
        <div id="analytics" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalFaturas">0</div>
                    <div>Total de Faturas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="faturasPagas">0</div>
                    <div>Faturas Pagas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="faturasPendentes">0</div>
                    <div>Faturas Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="mediaValor">R$ 0</div>
                    <div>Valor M√©dio</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="graficoNomes" aria-label="Gr√°fico de faturas por nome" role="img"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="graficoCategorias" aria-label="Gr√°fico de gastos por categoria" role="img"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="graficoCartoes" aria-label="Gr√°fico de uso de cart√µes de cr√©dito" role="img"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="graficoMensal" aria-label="Gr√°fico de evolu√ß√£o mensal dos gastos" role="img"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="graficoPrevisao" aria-label="Gr√°fico de previs√£o de gastos futuros" role="img"></canvas>
            </div>
        </div>
        <!-- ABA BACKUP -->
        <div id="backup" class="tab-content">
            <div class="export-controls">
                <h3><i class="fas fa-file-export"></i> Exportar Dados</h3>
                <button class="btn btn-export" onclick="exportarCSV()">
                    <i class="fas fa-file-csv"></i> Exportar CSV
                </button>
                <button class="btn btn-export" onclick="exportarBackup()">
                    <i class="fas fa-file-export"></i> Backup JSON
                </button>
                <button class="btn btn-export" onclick="gerarRelatorioHTML()">
                    <i class="fas fa-file-code"></i> Relat√≥rio HTML
                </button>
                <button class="btn btn-pdf" onclick="exportarPDF()">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
                <h3><i class="fas fa-file-import"></i> Importar Dados</h3>
                <input type="file" id="arquivoBackup" accept=".json" onchange="restaurarBackup(event)" style="margin-bottom: 10px;">
                <button class="btn btn-import" onclick="document.getElementById('arquivoBackup').click()">
                    <i class="fas fa-file-import"></i> Restaurar Backup
                </button>
                <h3><i class="fas fa-sync-alt"></i> Gerenciar Recorr√™ncias</h3>
                <button class="btn btn-add" onclick="gerarFaturasRecorrentes()">
                    <i class="fas fa-plus-circle"></i> Gerar Faturas do Pr√≥ximo M√™s
                </button>
                <button class="btn btn-delete" onclick="confirmarLimpezaDados()">
                    <i class="fas fa-trash"></i> Limpar Todos os Dados
                </button>
            </div>
        </div>
    </div>
    <!-- Modal de Confirma√ß√£o -->
    <div id="modalConfirmacao" class="modal" aria-hidden="true" aria-labelledby="modalTitulo" aria-describedby="modalMensagem">
        <div class="modal-content" role="dialog">
            <h3 id="modalTitulo">Confirmar a√ß√£o</h3>
            <p id="modalMensagem">Tem certeza que deseja realizar esta a√ß√£o?</p>
            <div class="modal-actions">
                <button class="btn" onclick="fecharModal()">Cancelar</button>
                <button class="btn btn-delete" id="modalConfirmarBtn">Confirmar</button>
            </div>
        </div>
    </div>
    <script>
        // Inicializar jsPDF
        window.jsPDF = window.jspdf.jsPDF;
        // Formatter de moeda
        const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        // Helpers de data (uso local para evitar problemas de fuso/ISO)
        const MS_DIA = 24 * 60 * 60 * 1000;
        function parseYMD(ymd) { if (!ymd) return null; const [y,m,d] = ymd.split('-').map(Number); return new Date(y, m-1, d); }
        function formatYMD(d) { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
        function hojeYMD() { return formatYMD(new Date()); }
        function diffDias(fromYMD, toYMD) {
            const a = parseYMD(fromYMD), b = parseYMD(toYMD);
            if (!a || !b) return 0;
            a.setHours(0,0,0,0); b.setHours(0,0,0,0);
            return Math.round((b - a) / MS_DIA);
        }
        function formatarData(data) {
            if (!data) return '-';
            const [ano, mes, dia] = data.split('-');
            return `${dia}/${mes}/${ano}`;
        }
        function obterDataAtual() { return hojeYMD(); }
        // Escapar HTML para evitar XSS
        function esc(str='') {
            return String(str).replace(/[&<>"'/]/g, s =>
                ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;'}[s])
            );
        }
        let faturas = [];
        let editandoId = null;
        let ordenacaoAtual = { campo: 'vencimento', direcao: 'asc' };
        let graficos = {};
        let paginaAtual = 1;
        const itensPorPagina = 10;
        let mesCalendar = new Date().getMonth();
        let anoCalendar = new Date().getFullYear();
        let visualizacaoAtual = 'tabela'; // 'tabela' ou 'calendario'
        // Carregar configura√ß√µes
        window.onload = function() {
            carregarTema();
            carregarPreferenciaFiltros();
            carregarDados();
            carregarConfiguracoesAlerta();
            atualizarCategoriasFiltro();
            definirDatasMinimas();
            verificarVencimentoProximo();
            atualizarSugestoesCategorias();
            atualizarDashboard();
            // Busca com debounce
            document.getElementById('buscaNome').onkeyup = debounce(filtrarFaturas, 200);
            // Cores aleat√≥rias no Backup ao carregar
            aplicarCoresAleatoriasBackup();
            // Aplicar cores aleat√≥rias nos bot√µes de a√ß√µes r√°pidas
            aplicarCoresAleatoriasQuickActions();
            // Inicializar calend√°rio
            atualizarCalendar();
            // Inicializar busca inteligente
            inicializarBuscaInteligente();
        }
        function carregarTema() {
            const tema = localStorage.getItem('tema') || 'light';
            document.documentElement.setAttribute('data-theme', tema);
        }
        function carregarPreferenciaFiltros() {
            const filtrosVisiveis = localStorage.getItem('filtrosVisiveis') !== 'false';
            const filterContainer = document.getElementById('filterContainer');
            if (!filtrosVisiveis) {
                filterContainer.classList.add('hidden');
            }
        }
        function carregarConfiguracoesAlerta() {
            const alertaDias = localStorage.getItem('alertaDias') || '7';
            const alertaEmail = localStorage.getItem('alertaEmail') === 'true';
            const alertaNotificacao = localStorage.getItem('alertaNotificacao') !== 'false';
            document.getElementById('alertaDias').value = alertaDias;
            document.getElementById('alertaEmail').checked = alertaEmail;
            document.getElementById('alertaNotificacao').checked = alertaNotificacao;
        }
        function salvarConfiguracoesAlerta() {
            const alertaDias = document.getElementById('alertaDias').value;
            const alertaEmail = document.getElementById('alertaEmail').checked;
            const alertaNotificacao = document.getElementById('alertaNotificacao').checked;
            localStorage.setItem('alertaDias', alertaDias);
            localStorage.setItem('alertaEmail', alertaEmail);
            localStorage.setItem('alertaNotificacao', alertaNotificacao);
            verificarVencimentoProximo();
            atualizarDashboard();
        }
        function carregarDados() {
            const dadosSalvos = localStorage.getItem('faturas');
            if (dadosSalvos) {
                faturas = JSON.parse(dadosSalvos);
            }
            atualizarTabela();
            atualizarAnalytics();
        }
        function definirDatasMinimas() {
            const hoje = hojeYMD();
            ['fechamento', 'vencimento'].forEach(id => {
                const input = document.getElementById(id);
                if (!input.value) input.setAttribute('min', hoje);
            });
        }
        // Gerenciamento de abas
        function mostrarAba(e, aba) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.getElementById(aba).classList.add('active');
            // Atualizar o menu mobile
            document.querySelector('.mobile-tabs-menu').value = aba;
            if (aba === 'analytics') {
                atualizarAnalytics();
            }
            if (aba === 'backup') {
                aplicarCoresAleatoriasBackup();
            }
            if (aba === 'faturas') {
                aplicarCoresAleatoriasQuickActions();
            }
        }
        function mostrarAbaMobile(aba) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const tab = document.querySelector(`.tab[data-aba="${aba}"]`);
            if (tab) tab.classList.add('active');
            document.getElementById(aba).classList.add('active');
            if (aba === 'analytics') {
                atualizarAnalytics();
            }
            if (aba === 'backup') {
                aplicarCoresAleatoriasBackup();
            }
            if (aba === 'faturas') {
                aplicarCoresAleatoriasQuickActions();
            }
        }
        // Alternar entre visualiza√ß√£o de tabela e calend√°rio
        function alternarVisualizacao() {
            const tableView = document.getElementById('tableView');
            const calendarView = document.getElementById('calendarView');
            const toggleBtn = document.querySelector('.view-toggle');
            if (visualizacaoAtual === 'tabela') {
                visualizacaoAtual = 'calendario';
                tableView.style.display = 'none';
                calendarView.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-list"></i> Ver Lista';
                atualizarCalendar();
            } else {
                visualizacaoAtual = 'tabela';
                tableView.style.display = 'block';
                calendarView.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Ver Calend√°rio';
            }
        }
        // Tema
        function alternarTema() {
            const tema = document.documentElement.getAttribute('data-theme');
            const novoTema = tema === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', novoTema);
            localStorage.setItem('tema', novoTema);
            if (document.getElementById('analytics').classList.contains('active')) {
                setTimeout(() => atualizarAnalytics(), 100);
            }
            if (document.getElementById('backup').classList.contains('active')) {
                aplicarCoresAleatoriasBackup();
            }
            if (document.getElementById('faturas').classList.contains('active')) {
                aplicarCoresAleatoriasQuickActions();
            }
        }
        // Filtros
        function resetFiltros() {
            document.getElementById('filtroTipo').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroCategoria').value = '';
            document.getElementById('buscaNome').value = '';
            document.getElementById('buscaValorMin').value = '';
            document.getElementById('buscaValorMax').value = '';
            document.getElementById('buscaDataInicio').value = '';
            document.getElementById('buscaDataFim').value = '';
            document.getElementById('advancedSearch').style.display = 'none';
            // esconder sugest√µes
            document.querySelectorAll('.search-suggestions').forEach(el => el.style.display = 'none');
        }
        function alternarFiltros() {
            const filterContainer = document.getElementById('filterContainer');
            filterContainer.classList.toggle('hidden');
            const isVisible = !filterContainer.classList.contains('hidden');
            localStorage.setItem('filtrosVisiveis', isVisible);
            if (!isVisible) {
                resetFiltros();
            }
            atualizarTabela();
        }
        // CRUD de faturas
        function adicionarFatura(event) {
            event.preventDefault();
            const tipo = document.getElementById('tipo').value;
            const nome = document.getElementById('nome').value.trim();
            const categoria = (document.getElementById('categoria').value || 'Geral').trim();
            const fechamento = document.getElementById('fechamento').value;
            const vencimento = document.getElementById('vencimento').value;
            const valor = parseFloat(document.getElementById('valor').value);
            const recorrente = document.getElementById('recorrente').checked;
            if (!tipo) {
                exibirNotificacao('Por favor, selecione um tipo de fatura!', 'error');
                return;
            }
            if (!nome || !fechamento || !vencimento || isNaN(valor)) {
                exibirNotificacao('Por favor, preencha todos os campos corretamente!', 'error');
                return;
            }
            if (parseYMD(vencimento) <= parseYMD(fechamento)) {
                exibirNotificacao('A data de vencimento deve ser posterior √† data de fechamento!', 'error');
                return;
            }
            if (editandoId) {
                const index = faturas.findIndex(f => f.id === editandoId);
                if (index !== -1) {
                    if (faturas[index].pago) {
                        exibirNotificacao('N√£o √© poss√≠vel editar uma fatura j√° paga!', 'error');
                        return;
                    }
                    faturas[index] = {
                        ...faturas[index],
                        tipo, nome, categoria, fechamento, vencimento, valor, recorrente
                    };
                    exibirNotificacao('Fatura atualizada com sucesso!', 'success');
                }
                cancelarEdicao();
            } else {
                const novaFatura = {
                    id: (crypto?.randomUUID?.() || String(Date.now())),
                    tipo, nome, categoria, fechamento, vencimento, valor, recorrente,
                    pago: false,
                    dataPagamento: null,
                    historicoPagamentos: []
                };
                faturas.push(novaFatura);
                exibirNotificacao('Fatura adicionada com sucesso!', 'success');
            }
            atualizarLocalStorage();
            atualizarTabela();
            atualizarCategoriasFiltro();
            atualizarSugestoesCategorias();
            verificarVencimentoProximo();
            atualizarDashboard();
            atualizarCalendar();
            limparFormulario();
        }
        
        // Fun√ß√£o para adicionar fatura rapidamente
        function adicionarFaturaRapida() {
            // Verifica se o formul√°rio est√° vis√≠vel
            const form = document.getElementById('formFatura');
            const formRect = form.getBoundingClientRect();
            
            // Se o formul√°rio n√£o estiver vis√≠vel na tela, rola at√© ele
            if (formRect.top < 0 || formRect.bottom > window.innerHeight) {
                scrollToForm();
                
                // D√° um tempo para o scroll completar antes de tentar submeter
                setTimeout(() => {
                    // Verifica se os campos obrigat√≥rios est√£o preenchidos
                    const tipo = document.getElementById('tipo').value;
                    const nome = document.getElementById('nome').value.trim();
                    const fechamento = document.getElementById('fechamento').value;
                    const vencimento = document.getElementById('vencimento').value;
                    const valor = document.getElementById('valor').value;
                    
                    if (tipo && nome && fechamento && vencimento && valor) {
                        // Se todos os campos estiverem preenchidos, submete o formul√°rio
                        form.dispatchEvent(new Event('submit'));
                    } else {
                        // Se n√£o, foca no primeiro campo vazio
                        if (!tipo) document.getElementById('tipo').focus();
                        else if (!nome) document.getElementById('nome').focus();
                        else if (!fechamento) document.getElementById('fechamento').focus();
                        else if (!vencimento) document.getElementById('vencimento').focus();
                        else if (!valor) document.getElementById('valor').focus();
                        
                        exibirNotificacao('Por favor, preencha todos os campos obrigat√≥rios!', 'warning');
                    }
                }, 500);
            } else {
                // Se o formul√°rio j√° estiver vis√≠vel, apenas submete
                form.dispatchEvent(new Event('submit'));
            }
        }
        
        function editarFatura(id) {
            const fatura = faturas.find(f => f.id === id);
            if (!fatura || fatura.pago) {
                exibirNotificacao('N√£o √© poss√≠vel editar uma fatura j√° paga!', 'error');
                return;
            }
            document.getElementById('tipo').value = fatura.tipo;
            document.getElementById('nome').value = fatura.nome;
            document.getElementById('categoria').value = fatura.categoria || '';
            document.getElementById('fechamento').value = fatura.fechamento;
            document.getElementById('vencimento').value = fatura.vencimento;
            document.getElementById('valor').value = fatura.valor;
            document.getElementById('recorrente').checked = fatura.recorrente || false;
            // permitir edi√ß√£o retroativa
            document.getElementById('fechamento').removeAttribute('min');
            document.getElementById('vencimento').removeAttribute('min');
            editandoId = id;
            document.getElementById('btnAdd').textContent = 'Atualizar Fatura';
            document.getElementById('btnAdd').innerHTML = '<i class="fas fa-save"></i> Atualizar Fatura';
            document.getElementById('btnCancel').style.display = 'inline-block';
            window.scrollTo(0, 0);
        }
        function cancelarEdicao() {
            editandoId = null;
            document.getElementById('btnAdd').textContent = 'Adicionar Fatura';
            document.getElementById('btnAdd').innerHTML = '<i class="fas fa-plus"></i> Adicionar Fatura';
            document.getElementById('btnCancel').style.display = 'none';
            limparFormulario();
            definirDatasMinimas();
        }
        function limparFormulario() {
            const form = document.getElementById('formFatura');
            if (form) form.reset();
        }
        function excluirFatura(id) {
            const fatura = faturas.find(f => f.id === id);
            let mensagem = 'Tem certeza que deseja excluir esta fatura?';
            if (fatura && fatura.pago) {
                mensagem = 'Esta fatura j√° foi paga. Tem certeza que deseja exclu√≠-la?';
            }
            mostrarModal(
                'Confirmar exclus√£o',
                mensagem,
                () => {
                    faturas = faturas.filter(f => f.id !== id);
                    atualizarLocalStorage();
                    atualizarTabela();
                    atualizarCategoriasFiltro();
                    verificarVencimentoProximo();
                    atualizarDashboard();
                    atualizarCalendar();
                    exibirNotificacao('Fatura exclu√≠da com sucesso!', 'success');
                    fecharModal();
                }
            );
        }
        function marcarComoPago(id, estaPago) {
            const fatura = faturas.find(f => f.id === id);
            if (!fatura) return;
            const acao = estaPago ? 'marcar como paga' : 'desmarcar pagamento';
            mostrarModal(
                'Confirmar a√ß√£o',
                `Tem certeza que deseja ${acao} esta fatura?`,
                () => {
                    fatura.pago = estaPago;
                    fatura.dataPagamento = estaPago ? hojeYMD() : null;
                    if (estaPago) {
                        fatura.historicoPagamentos.push({
                            data: new Date().toISOString(),
                            valor: fatura.valor
                        });
                    }
                    atualizarLocalStorage();
                    atualizarTabela();
                    verificarVencimentoProximo();
                    atualizarDashboard();
                    atualizarCalendar();
                    exibirNotificacao(`Fatura ${estaPago ? 'paga' : 'desmarcada'} com sucesso!`, 'success');
                    if (editandoId === id) {
                        cancelarEdicao();
                    }
                    fecharModal();
                }
            );
        }
        // Atualiza√ß√£o da tabela
        function atualizarTabela() {
            const tbody = document.querySelector('#tabelaFaturas tbody');
            tbody.innerHTML = '';
            // Ordena√ß√£o est√°vel
            const pares = faturas.map((f, i) => ({ f, i }));
            const comparar = (a, b) => {
                let valorA, valorB;
                switch (ordenacaoAtual.campo) {
                    case 'tipo':
                    case 'nome':
                    case 'categoria':
                        valorA = (a.f[ordenacaoAtual.campo] || '').toLowerCase();
                        valorB = (b.f[ordenacaoAtual.campo] || '').toLowerCase();
                        break;
                    case 'fechamento':
                    case 'vencimento':
                        valorA = parseYMD(a.f[ordenacaoAtual.campo]);
                        valorB = parseYMD(b.f[ordenacaoAtual.campo]);
                        break;
                    case 'valor':
                        valorA = a.f.valor;
                        valorB = b.f.valor;
                        break;
                    default:
                        valorA = a.i; valorB = b.i;
                }
                let res = 0;
                if (valorA instanceof Date && valorB instanceof Date) {
                    res = valorA - valorB;
                } else {
                    res = valorA > valorB ? 1 : valorA < valorB ? -1 : 0;
                }
                if (ordenacaoAtual.direcao === 'desc') res = -res;
                if (res === 0) res = a.i - b.i; // est√°vel
                return res;
            };
            const faturasOrdenadas = pares.sort(comparar).map(p => p.f);
            // Aplicar filtros
            const faturasFiltradas = aplicarFiltros(faturasOrdenadas);
            // Pagina√ß√£o
            const totalPaginas = Math.ceil(faturasFiltradas.length / itensPorPagina);
            paginaAtual = Math.min(paginaAtual, totalPaginas || 1);
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = inicio + itensPorPagina;
            const faturasPagina = faturasFiltradas.slice(inicio, fim);
            // Atualizar indicadores de ordena√ß√£o
            document.querySelectorAll('.sort-indicator').forEach(el => {
                el.textContent = '‚Üï';
            });
            const indicador = document.getElementById(`sort-${ordenacaoAtual.campo}`);
            if (indicador) {
                indicador.textContent = ordenacaoAtual.direcao === 'asc' ? '‚Üë' : '‚Üì';
            }
            let totalPendente = 0;
            let totalPago = 0;
            const hoje = hojeYMD();
            faturasPagina.forEach(fatura => {
                const tr = document.createElement('tr');
                const icones = {
                    cartao: 'üí≥', celular: 'üì±', internet: 'üõú', boleto: 'üìÉ',
                    streaming: 'üì∫', seguro: 'üõ°Ô∏è', financiamento: 'üè†', outros: 'üì¶'
                };
                const icone = icones[fatura.tipo] || 'üì¶';
                const tipoDisplay = fatura.tipo ? fatura.tipo.charAt(0).toUpperCase() + fatura.tipo.slice(1) : '';
                const d = diffDias(hoje, fatura.vencimento);
                let avisoVencimento = '';
                if (fatura.pago) {
                    avisoVencimento = ` <span style="color: var(--success-color);">üí∞ ${formatarData(fatura.dataPagamento)}</span>`;
                } else if (d < 0) {
                    avisoVencimento = ` <span class="expired">(Vencida h√° ${Math.abs(d)} dias)</span>`;
                } else if (d === 0) {
                    avisoVencimento = ` <span class="warning">(Vence hoje)</span>`;
                } else if (d <= 7) {
                    avisoVencimento = ` <span class="warning">(Vence em ${d} dias)</span>`;
                }
                // Gerar cor para a categoria
                const categoriaHash = fatura.categoria ? fatura.categoria.split('').reduce((a, b) => {
                    a = ((a << 5) - a) + b.charCodeAt(0);
                    return a & a;
                }, 0) : 0;
                const categoriaColorIndex = Math.abs(categoriaHash) % 16 + 1;
                const nomeSeguro = esc(fatura.nome);
                const categoriaSegura = esc(fatura.categoria || 'Geral');
                const categoriaTag = fatura.categoria ?
                    `<span class="categoria-tag category-color-${categoriaColorIndex}">${categoriaSegura}</span>` : '';
                const recorrenteBadge = fatura.recorrente ? `<span class="recorrente-badge">üîÑ</span>` : '';
                tr.innerHTML = `
                    <td>${icone} ${esc(tipoDisplay)}</td>
                    <td>${nomeSeguro} ${fatura.pago ? 'üîí' : ''} ${recorrenteBadge}</td>
                    <td>${categoriaSegura}${categoriaTag}</td>
                    <td>${formatarData(fatura.fechamento)}</td>
                    <td>${formatarData(fatura.vencimento)}${avisoVencimento}</td>
                    <td class="amount ${fatura.pago ? 'paid' : 'unpaid'}">${fmtBRL.format(fatura.valor)}</td>
                    <td>
                        ${!fatura.pago ?
                            `<button class="btn btn-edit" onclick="editarFatura('${fatura.id}')" aria-label="Editar fatura">
                                <i class="fas fa-edit"></i>
                            </button>` :
                            '<span class="lock-icon" aria-hidden="true">üîí</span>'
                        }
                        <button class="btn btn-delete" onclick="excluirFatura('${fatura.id}')" aria-label="Excluir fatura">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-paid" onclick="marcarComoPago('${fatura.id}', ${!fatura.pago})" aria-label="${fatura.pago ? 'Desfazer pagamento' : 'Pagar fatura'}">
                            ${fatura.pago ? '<i class="fas fa-undo"></i>' : '<i class="fas fa-check"></i>'}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
                if (fatura.pago) {
                    totalPago += fatura.valor;
                } else {
                    totalPendente += fatura.valor;
                }
            });
            document.getElementById('resumoTotal').innerHTML = `
                ‚è≥ Total de faturas pendentes: ${fmtBRL.format(totalPendente)}<br>
                üí∞ Total de faturas pagas: ${fmtBRL.format(totalPago)}
            `;
            atualizarPaginacao(totalPaginas);
        }
        function aplicarFiltros(faturasLista) {
            const filtroTipo = document.getElementById('filtroTipo').value;
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroCategoria = document.getElementById('filtroCategoria').value;
            const buscaNome = document.getElementById('buscaNome').value.toLowerCase();
            const valorMin = parseFloat(document.getElementById('buscaValorMin').value) || 0;
            const valorMax = parseFloat(document.getElementById('buscaValorMax').value) || Number.MAX_SAFE_INTEGER;
            const dataInicio = document.getElementById('buscaDataInicio').value;
            const dataFim = document.getElementById('buscaDataFim').value;
            return faturasLista.filter(fatura => {
                const tipoMatch = !filtroTipo || fatura.tipo === filtroTipo;
                const statusMatch = !filtroStatus ||
                    (filtroStatus === 'pago' && fatura.pago) ||
                    (filtroStatus === 'pendente' && !fatura.pago);
                const categoriaMatch = !filtroCategoria || fatura.categoria === filtroCategoria;
                const nomeMatch = !buscaNome || (fatura.nome || '').toLowerCase().includes(buscaNome);
                const valorMatch = fatura.valor >= valorMin && fatura.valor <= valorMax;
                let dataMatch = true;
                if (dataInicio) {
                    dataMatch = dataMatch && parseYMD(fatura.vencimento) >= parseYMD(dataInicio);
                }
                if (dataFim) {
                    dataMatch = dataMatch && parseYMD(fatura.vencimento) <= parseYMD(dataFim);
                }
                return tipoMatch && statusMatch && categoriaMatch && nomeMatch && valorMatch && dataMatch;
            });
        }
        function atualizarPaginacao(totalPaginas) {
            const paginacao = document.getElementById('paginacao');
            paginacao.innerHTML = '';
            if (totalPaginas <= 1) return;
            if (paginaAtual > 1) {
                const btnAnterior = document.createElement('button');
                btnAnterior.innerHTML = '<i class="fas fa-chevron-left"></i>';
                btnAnterior.onclick = () => mudarPagina(paginaAtual - 1);
                paginacao.appendChild(btnAnterior);
            }
            for (let i = 1; i <= totalPaginas; i++) {
                const btnPagina = document.createElement('button');
                btnPagina.textContent = i;
                btnPagina.classList.toggle('active', i === paginaAtual);
                btnPagina.onclick = () => mudarPagina(i);
                paginacao.appendChild(btnPagina);
            }
            if (paginaAtual < totalPaginas) {
                const btnProximo = document.createElement('button');
                btnProximo.innerHTML = '<i class="fas fa-chevron-right"></i>';
                btnProximo.onclick = () => mudarPagina(paginaAtual + 1);
                paginacao.appendChild(btnProximo);
            }
        }
        function mudarPagina(pagina) {
            paginaAtual = pagina;
            atualizarTabela();
            window.scrollTo(0, 0);
        }
        // Filtros e ordena√ß√£o
        function ordenarTabela(campo) {
            if (ordenacaoAtual.campo === campo) {
                ordenacaoAtual.direcao = ordenacaoAtual.direcao === 'asc' ? 'desc' : 'asc';
            } else {
                ordenacaoAtual.campo = campo;
                ordenacaoAtual.direcao = 'asc';
            }
            paginaAtual = 1;
            atualizarTabela();
        }
        function filtrarFaturas() {
            paginaAtual = 1;
            atualizarTabela();
        }
        function toggleAdvancedSearch() {
            const advancedSearch = document.getElementById('advancedSearch');
            advancedSearch.style.display = advancedSearch.style.display === 'none' ? 'block' : 'none';
        }
        function atualizarCategoriasFiltro() {
            const select = document.getElementById('filtroCategoria');
            const categorias = [...new Set(faturas.map(f => f.categoria || 'Geral'))];
            select.innerHTML = '<option value="">Todas</option>';
            categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                select.appendChild(option);
            });
        }
        function atualizarSugestoesCategorias() {
            const datalist = document.getElementById('categoriasSugeridas');
            const categorias = [...new Set(faturas.map(f => f.categoria || 'Geral').filter(Boolean))];
            datalist.innerHTML = '';
            categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                datalist.appendChild(option);
            });
        }
        // Dashboard
        function atualizarDashboard() {
            const totalPendente = faturas.filter(f => !f.pago).reduce((sum, f) => sum + f.valor, 0);
            const totalPago = faturas.filter(f => f.pago).reduce((sum, f) => sum + f.valor, 0);
            const hoje = hojeYMD();
            const diasAlerta = parseInt(localStorage.getItem('alertaDias') || '7', 10);
            const proximosVencimentos = faturas.filter(f =>
                !f.pago &&
                diffDias(hoje, f.vencimento) >= 0 &&
                diffDias(hoje, f.vencimento) <= diasAlerta
            ).length;
            const atrasadas = faturas.filter(f =>
                !f.pago &&
                diffDias(hoje, f.vencimento) < 0
            ).length;
            document.getElementById('dashboard-total-pendente').textContent = fmtBRL.format(totalPendente);
            document.getElementById('dashboard-total-pago').textContent = fmtBRL.format(totalPago);
            document.getElementById('dashboard-proximos-vencimentos').textContent = proximosVencimentos;
            document.getElementById('dashboard-atrasadas').textContent = atrasadas;
        }
        // Filtros r√°pidos
        function filtrarPorStatus(status) {
            document.getElementById('filtroStatus').value = status;
            filtrarFaturas();
        }
        function filtrarPorVencimentoProximo() {
            const hoje = hojeYMD();
            const diasAlerta = parseInt(localStorage.getItem('alertaDias') || '7', 10);
            document.getElementById('buscaDataInicio').value = hoje;
            const dataFim = new Date();
            dataFim.setDate(dataFim.getDate() + diasAlerta);
            document.getElementById('buscaDataFim').value = formatYMD(dataFim);
            document.getElementById('filtroStatus').value = 'pendente';
            document.getElementById('advancedSearch').style.display = 'block';
            filtrarFaturas();
        }
        function scrollToForm() {
            document.getElementById('formFatura').scrollIntoView({ behavior: 'smooth' });
        }
        // Calendar functions
        function atualizarCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
                                "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('calendarMonth').textContent = `${monthNames[mesCalendar]} ${anoCalendar}`;
            calendarGrid.innerHTML = '';
            // Cabe√ßalho dos dias da semana
            const daysOfWeek = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
            for (let i = 0; i < 7; i++) {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = daysOfWeek[i];
                calendarGrid.appendChild(dayHeader);
            }
            // Obter o primeiro dia do m√™s e o √∫ltimo dia do m√™s
            const firstDay = new Date(anoCalendar, mesCalendar, 1);
            const lastDay = new Date(anoCalendar, mesCalendar + 1, 0);
            // Dias vazios no in√≠cio
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarGrid.appendChild(emptyDay);
            }
            // Dias do m√™s
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = i;
                day.appendChild(dayHeader);
                const currentDate = formatYMD(new Date(anoCalendar, mesCalendar, i));
                const dayFaturas = faturas.filter(f => f.vencimento === currentDate);
                dayFaturas.forEach(fatura => {
                    const event = document.createElement('div');
                    event.className = `calendar-event ${fatura.pago ? 'paid' : ''} ${!fatura.pago && diffDias(hojeYMD(), fatura.vencimento) < 0 ? 'expired' : ''}`;
                    event.textContent = `${fatura.nome} - ${fmtBRL.format(fatura.valor)}`;
                    event.onclick = () => {
                        if (fatura.pago) {
                            marcarComoPago(fatura.id, false);
                        } else {
                            marcarComoPago(fatura.id, true);
                        }
                    };
                    day.appendChild(event);
                });
                calendarGrid.appendChild(day);
            }
        }
        function mudarMesCalendar(delta) {
            mesCalendar += delta;
            if (mesCalendar < 0) {
                mesCalendar = 11;
                anoCalendar--;
            } else if (mesCalendar > 11) {
                mesCalendar = 0;
                anoCalendar++;
            }
            atualizarCalendar();
        }
        // Busca inteligente
        function inicializarBuscaInteligente() {
            document.getElementById('nome').addEventListener('input', function(e) {
                mostrarSugestoes(e.target.value, 'suggestions-container');
            });
            document.getElementById('buscaNome').addEventListener('input', function(e) {
                mostrarSugestoes(e.target.value, 'suggestions-container-table');
            });
            document.addEventListener('click', function(e) {
                if (!e.target.matches('#nome, #buscaNome')) {
                    document.querySelectorAll('.search-suggestions').forEach(el => {
                        el.style.display = 'none';
                    });
                }
            });
        }
        function mostrarSugestoes(query, containerId) {
            // suporte para chamadas sem containerId (ex.: atributo oninput no HTML)
            if (!containerId) {
                const ae = document.activeElement;
                if (ae && ae.id === 'nome') containerId = 'suggestions-container';
                else containerId = 'suggestions-container-table';
            }
            const container = document.getElementById(containerId);
            if (!container) return;
            if (!query) {
                container.style.display = 'none';
                container.innerHTML = '';
                return;
            }
            const sugestoes = [...new Set(faturas
                .filter(f => (f.nome || '').toLowerCase().includes(query.toLowerCase()))
                .map(f => f.nome)
            )].slice(0, 5);
            if (sugestoes.length === 0) {
                container.style.display = 'none';
                container.innerHTML = '';
                return;
            }
            container.innerHTML = '';
            sugestoes.forEach(sugestao => {
                const div = document.createElement('div');
                div.className = 'search-suggestion';
                div.textContent = sugestao;
                div.onclick = () => {
                    if (containerId === 'suggestions-container') {
                        document.getElementById('nome').value = sugestao;
                    } else {
                        document.getElementById('buscaNome').value = sugestao;
                        filtrarFaturas();
                    }
                    container.style.display = 'none';
                };
                container.appendChild(div);
            });
            container.style.display = 'block';
        }
        // Analytics e gr√°ficos
        function atualizarAnalytics() {
            const totalFaturas = faturas.length;
            const fPagas = faturas.filter(f => f.pago);
            const fPendentes = faturas.filter(f => !f.pago);
            const faturasPagas = fPagas.length;
            const faturasPendentes = fPendentes.length;
            const mediaValor = totalFaturas > 0 ?
                faturas.reduce((sum, f) => sum + f.valor, 0) / totalFaturas : 0;
            document.getElementById('totalFaturas').textContent = totalFaturas;
            document.getElementById('faturasPagas').textContent = faturasPagas;
            document.getElementById('faturasPendentes').textContent = faturasPendentes;
            document.getElementById('mediaValor').textContent = fmtBRL.format(mediaValor);
            criarGraficoNomes();
            criarGraficoCategorias();
            criarGraficoCartoes();
            criarGraficoMensal();
            criarGraficoPrevisao();
        }
        function criarGraficoNomes() {
            const ctx = document.getElementById('graficoNomes').getContext('2d');
            if (graficos.nomes) graficos.nomes.destroy();
            const nomesCount = {};
            faturas.forEach(f => {
                nomesCount[f.nome] = (nomesCount[f.nome] || 0) + 1;
            });
            const sortedNames = Object.entries(nomesCount).sort((a, b) => b[1] - a[1]);
            const topNames = sortedNames.slice(0, 10);
            const outrosCount = sortedNames.slice(10).reduce((sum, [_, count]) => sum + count, 0);
            const labels = topNames.map(([name, _]) => name);
            const data = topNames.map(([_, count]) => count);
            if (outrosCount > 0) {
                labels.push('Outros');
                data.push(outrosCount);
            }
            const cs = getComputedStyle(document.documentElement);
            const textColor = cs.getPropertyValue('--text-color').trim() || '#333';
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            const backgroundColors = isDark ? [
                'rgba(93, 173, 226, 0.8)',
                'rgba(88, 214, 141, 0.8)',
                'rgba(236, 112, 99, 0.8)',
                'rgba(248, 196, 113, 0.8)',
                'rgba(163, 122, 219, 0.8)',
                'rgba(231, 160, 132, 0.8)',
                'rgba(142, 198, 238, 0.8)',
                'rgba(231, 218, 132, 0.8)',
                'rgba(152, 195, 121, 0.8)',
                'rgba(238, 152, 152, 0.8)'
            ] : [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#8BC34A', '#C9CBCF',
                '#E7E9ED', '#F7464A', '#46BFBD', '#FDB45C'
            ];
            
            graficos.nomes = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Faturas por Nome',
                            color: textColor,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: { size: 12 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '50%'
                }
            });
        }
        function criarGraficoCategorias() {
            const ctx = document.getElementById('graficoCategorias').getContext('2d');
            if (graficos.categorias) graficos.categorias.destroy();
            const categoriasValor = {};
            faturas.forEach(f => {
                const cat = f.categoria || 'Geral';
                categoriasValor[cat] = (categoriasValor[cat] || 0) + f.valor;
            });
            const cs = getComputedStyle(document.documentElement);
            const textColor = cs.getPropertyValue('--text-color').trim() || '#333';
            const primary = cs.getPropertyValue('--primary-color').trim() || '#36A2EB';
            const gridColor = (document.documentElement.getAttribute('data-theme') === 'dark') ? '#555' : '#ddd';
            graficos.categorias = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categoriasValor),
                    datasets: [{
                        label: 'Valor Total (R$)',
                        data: Object.values(categoriasValor),
                        backgroundColor: primary
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Gastos por Categoria', color: textColor },
                        legend: { labels: { color: textColor } }
                    },
                    scales: {
                        y: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }
        function criarGraficoCartoes() {
            const ctx = document.getElementById('graficoCartoes').getContext('2d');
            if (graficos.cartoes) graficos.cartoes.destroy();
            const tiposCount = {};
            faturas.forEach(f => {
                tiposCount[f.tipo] = (tiposCount[f.tipo] || 0) + 1;
            });
            const cs = getComputedStyle(document.documentElement);
            const textColor = cs.getPropertyValue('--text-color').trim() || '#333';
            const gridColor = (document.documentElement.getAttribute('data-theme') === 'dark') ? '#555' : '#ddd';
            const coresTipos = {
                cartao: '#36A2EB',
                celular: '#FF6384',
                internet: '#FFCE56',
                boleto: '#4BC0C0',
                streaming: '#9966FF',
                seguro: '#FF9F40',
                financiamento: '#8BC34A',
                outros: '#C9CBCF'
            };
            const labels = Object.keys(tiposCount);
            const data = Object.values(tiposCount);
            const backgroundColors = labels.map(tipo => coresTipos[tipo] || '#C9CBCF');
            graficos.cartoes = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade de Faturas',
                        data: data,
                        backgroundColor: backgroundColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Distribui√ß√£o por Tipo de Fatura', color: textColor },
                        legend: { labels: { color: textColor } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: textColor, stepSize: 1 },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
        }
        function criarGraficoMensal() {
            const ctx = document.getElementById('graficoMensal').getContext('2d');
            if (graficos.mensal) graficos.mensal.destroy();
            const dadosMensais = {};
            faturas.forEach(f => {
                const mes = f.vencimento?.substring(0, 7);
                if (!mes) return;
                if (!dadosMensais[mes]) {
                    dadosMensais[mes] = { total: 0, pagos: 0, pendentes: 0 };
                }
                dadosMensais[mes].total += f.valor;
                if (f.pago) dadosMensais[mes].pagos += f.valor;
                else dadosMensais[mes].pendentes += f.valor;
            });
            const meses = Object.keys(dadosMensais).sort();
            const cs = getComputedStyle(document.documentElement);
            const textColor = cs.getPropertyValue('--text-color').trim() || '#333';
            const gridColor = (document.documentElement.getAttribute('data-theme') === 'dark') ? '#555' : '#ddd';
            graficos.mensal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [
                        { label: 'Total', data: meses.map(m => dadosMensais[m].total), borderColor: '#36A2EB', backgroundColor: 'rgba(54, 162, 235, 0.1)', fill: true },
                        { label: 'Pagos', data: meses.map(m => dadosMensais[m].pagos), borderColor: '#4BC0C0', backgroundColor: 'rgba(75, 192, 192, 0.1)', fill: true },
                        { label: 'Pendentes', data: meses.map(m => dadosMensais[m].pendentes), borderColor: '#FF6384', backgroundColor: 'rgba(255, 99, 132, 0.1)', fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Evolu√ß√£o Mensal dos Gastos', color: textColor },
                        legend: { labels: { color: textColor } }
                    },
                    scales: {
                        y: { ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
        }
        function criarGraficoPrevisao() {
            const ctx = document.getElementById('graficoPrevisao').getContext('2d');
            if (graficos.previsao) graficos.previsao.destroy();
            const hoje = new Date();
            const mesesDados = [];
            for (let i = 2; i >= 0; i--) {
                const mes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const mesStr = formatYMD(mes).substring(0, 7);
                mesesDados.push(mesStr);
            }
            let total = 0;
            let count = 0;
            mesesDados.forEach(mes => {
                const gastoMes = faturas
                    .filter(f => f.vencimento?.startsWith(mes))
                    .reduce((sum, f) => sum + f.valor, 0);
                total += gastoMes;
                count++;
            });
            const media = count > 0 ? total / count : 0;
            const mesesPrevisao = [];
            for (let i = 1; i <= 3; i++) {
                const mes = new Date(hoje.getFullYear(), hoje.getMonth() + i, 1);
                const mesNome = mes.toLocaleString('pt-BR', { month: 'short', year: 'numeric' });
                mesesPrevisao.push(mesNome);
            }
            const cs = getComputedStyle(document.documentElement);
            const textColor = cs.getPropertyValue('--text-color').trim() || '#333';
            const gridColor = (document.documentElement.getAttribute('data-theme') === 'dark') ? '#555' : '#ddd';
            graficos.previsao = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: mesesPrevisao,
                    datasets: [{
                        label: 'Previs√£o de Gastos (R$)',
                        data: [media, media, media],
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Previs√£o de Gastos Futuros (Baseada nos √∫ltimos 3 meses)', color: textColor },
                        legend: { labels: { color: textColor } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
        }
        // Fun√ß√µes de recorr√™ncia (evita duplicidades por nome+tipo+data)
        function gerarFaturasRecorrentes() {
            let geradas = 0;
            const novas = [];
            faturas.filter(f => f.recorrente).forEach((fatura, i) => {
                const proxV = parseYMD(fatura.vencimento); proxV.setMonth(proxV.getMonth() + 1);
                const proxF = parseYMD(fatura.fechamento); proxF.setMonth(proxF.getMonth() + 1);
                const vencProx = formatYMD(proxV);
                const jaExiste =
                    faturas.some(ff => ff.nome === fatura.nome && ff.tipo === fatura.tipo && ff.vencimento === vencProx) ||
                    novas.some(ff => ff.nome === fatura.nome && ff.tipo === fatura.tipo && ff.vencimento === vencProx);
                if (!jaExiste) {
                    novas.push({
                        ...fatura,
                        id: (crypto?.randomUUID?.() || String(Date.now() + i)),
                        fechamento: formatYMD(proxF),
                        vencimento: vencProx,
                        pago: false,
                        dataPagamento: null,
                        historicoPagamentos: []
                    });
                    geradas++;
                }
            });
            if (novas.length) {
                faturas = faturas.concat(novas);
                atualizarLocalStorage();
                atualizarTabela();
                atualizarCategoriasFiltro();
                verificarVencimentoProximo();
                atualizarDashboard();
                atualizarCalendar();
                exibirNotificacao(`${geradas} faturas recorrentes geradas para o pr√≥ximo m√™s!`, 'success');
            } else {
                exibirNotificacao('Nenhuma fatura recorrente nova foi gerada.', 'info');
            }
        }
        // Exporta√ß√£o e backup
        function exportarCSV() {
            const headers = ['Tipo', 'Nome', 'Categoria', 'Fechamento', 'Vencimento', 'Valor', 'Status', 'Data Pagamento', 'Recorrente'];
            const dadosFiltrados = aplicarFiltros([...faturas]);
            const csvContent = '\uFEFF' + [
                headers.join(','),
                ...dadosFiltrados.map(f => [
                    f.tipo,
                    `"${(f.nome || '').replace(/"/g, '""')}"`,
                    `"${((f.categoria || 'Geral')).replace(/"/g, '""')}"`,
                    formatarData(f.fechamento),
                    formatarData(f.vencimento),
                    f.valor.toFixed(2),
                    f.pago ? 'Pago' : 'Pendente',
                    f.dataPagamento ? formatarData(f.dataPagamento) : '',
                    f.recorrente ? 'Sim' : 'N√£o'
                ].join(','))
            ].join('\n');
            baixarArquivo(csvContent, `faturas_${obterDataAtual()}.csv`, 'text/csv;charset=utf-8;');
            exibirNotificacao('CSV exportado com sucesso!', 'success');
        }
        function exportarBackup() {
            const backup = {
                faturas: faturas,
                dataBackup: new Date().toISOString(),
                versao: '2.1',
                tema: localStorage.getItem('tema')
            };
            const json = JSON.stringify(backup, null, 2);
            baixarArquivo(json, `backup_faturas_${obterDataAtual()}.json`, 'application/json');
            exibirNotificacao('Backup criado com sucesso!', 'success');
        }
        function restaurarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.faturas && Array.isArray(backup.faturas)) {
                        mostrarModal(
                            'Restaurar Backup',
                            'Isso substituir√° todos os dados atuais. Continuar?',
                            () => {
                                faturas = backup.faturas;
                                if (backup.tema) {
                                    localStorage.setItem('tema', backup.tema);
                                    document.documentElement.setAttribute('data-theme', backup.tema);
                                }
                                atualizarLocalStorage();
                                atualizarTabela();
                                atualizarCategoriasFiltro();
                                verificarVencimentoProximo();
                                atualizarDashboard();
                                atualizarCalendar();
                                exibirNotificacao('Backup restaurado com sucesso!', 'success');
                                fecharModal();
                            }
                        );
                    } else {
                        exibirNotificacao('Arquivo de backup inv√°lido!', 'error');
                    }
                } catch (error) {
                    exibirNotificacao('Erro ao ler o arquivo de backup!', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        function gerarRelatorioHTML() {
            const totalGeral = faturas.reduce((sum, f) => sum + f.valor, 0);
            const totalPago = faturas.filter(f => f.pago).reduce((sum, f) => sum + f.valor, 0);
            const totalPendente = totalGeral - totalPago;
            const linhas = faturas.map(f => `
                <tr>
                    <td>${esc(f.tipo)}</td>
                    <td>${esc(f.nome)}</td>
                    <td>${esc(f.categoria || 'Geral')}</td>
                    <td>${formatarData(f.vencimento)}</td>
                    <td class="${f.pago ? 'paid' : 'unpaid'}">${fmtBRL.format(f.valor)}</td>
                    <td>${f.pago ? 'Pago' : 'Pendente'}</td>
                </tr>
            `).join('');
            const html = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio de Faturas - ${obterDataAtual()}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .summary { background-color: #e8f5e9; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .paid { color: green; text-decoration: line-through; }
        .unpaid { color: red; }
        h1, h2, h3 { font-weight: 700; }
    </style>
</head>
<body>
    <h1>Relat√≥rio de Faturas</h1>
    <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
    <div class="summary">
        <h3>Resumo Financeiro</h3>
        <p><strong>Total Geral:</strong> ${fmtBRL.format(totalGeral)}</p>
        <p><strong>Total Pago:</strong> ${fmtBRL.format(totalPago)}</p>
        <p><strong>Total Pendente:</strong> ${fmtBRL.format(totalPendente)}</p>
        <p><strong>Total de Faturas:</strong> ${faturas.length}</p>
    </div>
    <table>
        <thead>
            <tr>
                <th>Tipo</th>
                <th>Nome</th>
                <th>Categoria</th>
                <th>Vencimento</th>
                <th>Valor</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            ${linhas}
        </tbody>
    </table>
</body>
</html>`;
            baixarArquivo(html, `relatorio_faturas_${obterDataAtual()}.html`, 'text/html');
            exibirNotificacao('Relat√≥rio HTML gerado com sucesso!', 'success');
        }
        // Exportar PDF (considera filtros)
        function exportarPDF() {
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.setTextColor(40);
            doc.text('Relat√≥rio de Faturas', 105, 15, { align: 'center' });
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 105, 22, { align: 'center' });
            const dadosFiltrados = aplicarFiltros([...faturas]);
            const totalGeral = dadosFiltrados.reduce((sum, f) => sum + f.valor, 0);
            const totalPago = dadosFiltrados.filter(f => f.pago).reduce((sum, f) => sum + f.valor, 0);
            const totalPendente = totalGeral - totalPago;
            doc.setFontSize(14);
            doc.setTextColor(40);
            doc.text('Resumo Financeiro', 14, 35);
            doc.setFontSize(11);
            doc.text(`Total Geral: ${fmtBRL.format(totalGeral)}`, 20, 45);
            doc.text(`Total Pago: ${fmtBRL.format(totalPago)}`, 20, 52);
            doc.text(`Total Pendente: ${fmtBRL.format(totalPendente)}`, 20, 59);
            doc.text(`Total de Faturas: ${dadosFiltrados.length}`, 20, 66);
            const tableData = dadosFiltrados.map(f => [
                f.tipo,
                f.nome,
                f.categoria || 'Geral',
                formatarData(f.vencimento),
                fmtBRL.format(f.valor),
                f.pago ? 'Pago' : 'Pendente'
            ]);
            doc.autoTable({
                head: [['Tipo', 'Nome', 'Categoria', 'Vencimento', 'Valor', 'Status']],
                body: tableData,
                startY: 75,
                theme: 'grid',
                headStyles: {
                    fillColor: [66, 139, 202],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: { fillColor: [240, 240, 240] },
                styles: { fontSize: 9, cellPadding: 3, overflow: 'linebreak' },
                margin: { top: 75 }
            });
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.text(`P√°gina ${i} de ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
            }
            doc.save(`relatorio_faturas_${obterDataAtual()}.pdf`);
            exibirNotificacao('PDF exportado com sucesso!', 'success');
        }
        function confirmarLimpezaDados() {
            mostrarModal(
                'Confirmar limpeza',
                'ATEN√á√ÉO: Isso excluir√° TODOS os dados permanentemente. Esta a√ß√£o n√£o pode ser desfeita. Continuar?',
                () => {
                    limparDados();
                    fecharModal();
                }
            );
        }
        function limparDados() {
            faturas = [];
            atualizarLocalStorage();
            atualizarTabela();
            atualizarCategoriasFiltro();
            verificarVencimentoProximo();
            atualizarDashboard();
            atualizarCalendar();
            exibirNotificacao('Todos os dados foram limpos!', 'success');
        }
        // Modal functions
        function mostrarModal(titulo, mensagem, callback) {
            document.getElementById('modalTitulo').textContent = titulo;
            document.getElementById('modalMensagem').textContent = mensagem;
            const btnConfirm = document.getElementById('modalConfirmarBtn');
            btnConfirm.onclick = callback;
            const modal = document.getElementById('modalConfirmacao');
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            setTimeout(() => btnConfirm.focus(), 0);
        }
        function fecharModal() {
            const modal = document.getElementById('modalConfirmacao');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
        }
        // Auxiliares
        function atualizarLocalStorage() {
            localStorage.setItem('faturas', JSON.stringify(faturas));
        }
        function baixarArquivo(conteudo, nomeArquivo, tipo) {
            const blob = new Blob([conteudo], { type: tipo });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        function exibirNotificacao(mensagem, tipo) {
            const notification = document.getElementById('notification');
            notification.textContent = mensagem;
            notification.className = 'notification ' + tipo;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }
        // Notifica√ß√µes de vencimento (janela de +/- diasAlerta)
        function verificarVencimentoProximo() {
            const alertaNotificacao = localStorage.getItem('alertaNotificacao') !== 'false';
            const notificacao = document.getElementById('notificacaoVencimento');
            const lista = document.getElementById('listaVencimentoProximo');
            if (!alertaNotificacao) {
                notificacao.style.display = 'none';
                return;
            }
            const hoje = hojeYMD();
            const diasAlerta = parseInt(localStorage.getItem('alertaDias') || '7', 10);
            const vencimentoProximo = faturas.filter(fatura => {
                if (fatura.pago) return false;
                const d = diffDias(hoje, fatura.vencimento);
                return d >= -diasAlerta && d <= diasAlerta;
            });
            if (vencimentoProximo.length === 0) {
                notificacao.style.display = 'none';
                lista.innerHTML = '';
                return;
            }
            let html = '<ul style="margin-top: 10px; margin-bottom: 0;">';
            vencimentoProximo.forEach(fatura => {
                const d = diffDias(hoje, fatura.vencimento);
                let texto = '';
                if (d < 0) texto = `Vencida h√° ${Math.abs(d)} dias`;
                else if (d === 0) texto = 'Vence hoje';
                else texto = `Vence em ${d} dias`;
                html += `<li><strong>${esc(fatura.nome)}</strong> - ${texto} - ${fmtBRL.format(fatura.valor)}</li>`;
            });
            html += '</ul>';
            lista.innerHTML = html;
            notificacao.style.display = 'block';
        }
        function fecharNotificacaoVencimento() {
            const notificacao = document.getElementById('notificacaoVencimento');
            notificacao.style.display = 'none';
        }
        // Cores aleat√≥rias para os bot√µes
        function gerarCorAleatoriaRGB(min = 70, max = 200) {
            const rand = () => Math.floor(Math.random() * (max - min + 1)) + min;
            const r = rand(), g = rand(), b = rand();
            return { r, g, b, css: `rgb(${r}, ${g}, ${b})` };
        }
        function corTextoContraste({ r, g, b }) {
            const yiq = (r * 299 + g * 587 + b * 114) / 1000;
            return yiq >= 150 ? '#000' : '#fff';
        }
        function aplicarCoresAleatoriasBackup() {
            const botoes = document.querySelectorAll('#backup .export-controls button.btn');
            botoes.forEach(btn => {
                const cor = gerarCorAleatoriaRGB();
                btn.style.backgroundColor = cor.css;
                btn.style.color = corTextoContraste(cor);
                btn.style.fontWeight = '700';
                btn.style.border = 'none';
            });
        }
        function aplicarCoresAleatoriasQuickActions() {
            const botoes = document.querySelectorAll('.quick-actions .quick-action-btn');
            botoes.forEach(btn => {
                const cor = gerarCorAleatoriaRGB();
                btn.style.backgroundColor = cor.css;
                btn.style.color = corTextoContraste(cor);
                btn.style.fontWeight = '700';
                btn.style.border = 'none';
                btn.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            });
        }
        // Fechar modal clicando fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalConfirmacao');
            if (event.target === modal) {
                fecharModal();
            }
        };
        // Fechar modal com ESC
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') fecharModal(); });
        // Debounce
        function debounce(fn, delay = 200) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), delay);
            };
        }
    </script>
</body>
</html>
